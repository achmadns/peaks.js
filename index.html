<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" content="text/html">
  <meta name="viewport" content="width=device-width">
  <title>Peaks.js Demo Page</title>
  <style>

    #titles {
      font-family: 'Helvetica neue', Helvetica, Arial, sans-serif;
    }

    #titles, [id*="waveform-visualiser"] {
      margin: 24px auto;
      width: 1000px;
    }

    [id*="waveform-visualiser"] [class*="-container"] {
      box-shadow: 3px 3px 20px #919191;
      margin: 0 0 24px 0;
      -moz-box-shadow: 3px 3px 20px #919191;
      -webkit-box-shadow: 3px 3px 20px #919191;
      line-height: 0;
    }

    .overview-container {
      height: 85px;
    }

    #second-waveform-visualiser-container [class*="-container"] {
      background: #111;
    }

    #demo-controls {
      margin: 0 auto 24px auto;
      width: 1000px;
    }

    #demo-controls > * {
      vertical-align: middle;
    }

    #demo-controls button {
      background: #fff;
      border: 1px solid #919191;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div id="first-waveform-visualiser-container"></div>

<div id="demo-controls">
  <audio controls=controls id="audio" crossorigin="anonymous">
    <source src="http://icecast.local:8000/audio.ogg" type="audio/ogg">
    <!--https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types-->
    <!--<source src="/test_data/TOL_6min_720p_download.mp3" type="audio/mpeg">-->
    <!--<source src="test_data/button.mp3" type="audio/mpeg">-->
    <!--<source src="test_data/bells.mp3" type="audio/mpeg">-->
    <!--<source src="audio/faatihah-13-secs.mp3" type="audio/mpeg">-->
    Your browser does not support the audio element.
  </audio>

  <button data-action="zoom-in">Zoom in</button>
  <button data-action="zoom-out">Zoom out</button>
  <button data-action="add-segment">Add a Segment at current time</button>
  <button data-action="add-point">Add a Point at current time</button>
  <button data-action="log-data">Log segments/points</button>
</div>

<script src="node_modules/waveform-data/dist/waveform-data.js"></script>
<script src="node_modules/waveform-data/dist/webaudio.js"></script>
<script src="node_modules/webaudio-peaks/dist/webaudio-peaks.umd.js"></script>
<script src="node_modules/eventemitter2/lib/eventemitter2.js"></script>
<script src="bower_components/stomp-websocket/lib/stomp.js"></script>
<script src="peaks.js"></script>
<script>
  (function (Peaks) {
    const WaveformData = window.WaveformData;
    const webAudioBuilder = window.WaveformDataWebaudioBuilder;
    const audioContext = new AudioContext();
    const audioOrigin = document.getElementById('audio');
    const audioSource = audioContext.createMediaElementSource(audioOrigin);
    const scriptSource = audioContext.createMediaElementSource(audioOrigin);
    const scriptProcessor = audioContext.createScriptProcessor();
    var peaksInstance;
    var connected = false;
    const ee = new EventEmitter2();
    const wsUrl = 'ws://localhost:6161/ws?access_token=abc';
    const stomp = Stomp.over(new WebSocket(wsUrl));

    stomp.debug = null;
    stomp.connect({}, function (frame) {
      ee.on('peaks.data', function (data) {
        // beware, the stringified array is an object with format ["index": element, [..]]
        const peaks = JSON.stringify(data).replace('[', '').replace(']', '');
        stomp.send('/topic/peaks.data', {}, peaks);
      });
      console.log('Peaks data stream initialized.');
    }, function (error) {
      console.log('Failed to connect to ws server at ' + wsUrl);
    });

    audioSource.connect(audioContext.destination);

    var waveform = {
      sample_rate: 44100,
      sample_per_pixel: 512,
      bits: 8,
      length: 0,
      data: []
    };

    var options = {
      container: document.getElementById('first-waveform-visualiser-container'),
      mediaElement: audioOrigin,
      dataUri: {
        json: 'peaks.json'
      },
      keyboard: false
    };

    ee.on('peaks.reinit', function (options) {
      peaksInstance.destroy();
      peaksInstance = Peaks.init(options);
      peaksInstance.on('error', function (err) {
        console.log("Oops! " + err);
      });
    });

    ee.on('peaks.start', function () {
      const intervalId = setInterval(function () {
        ee.emit('peaks.reinit', options);
      }, 1000);

      ee.on('peaks.stop', function () {
        clearInterval(intervalId);
      });
    });

    scriptProcessor.onaudioprocess = function (audioProcessEvent) {
      // inputBuffer is AudioBuffer
      const inputBuffer = audioProcessEvent.inputBuffer;
      const channelData = inputBuffer.getChannelData(0);
      const peaks = webaudioPeaks(channelData, 512, 8);
      const data = peaks.data[0];
      ee.emit('peaks.data', data);
    };

    function connectAnalysers() {
      if (connected) return;
      scriptSource.connect(scriptProcessor);
      console.log('Audio ready to be analysed.');
      connected = true;
    };

    function disconnectAnalysers() {
      scriptSource.disconnect();
    };

    audioOrigin.onplay = function () {
      connectAnalysers();
      ee.emit('peaks.start');
    };
    function stopDataRequest() {
      disconnectAnalysers();
    };

    audioOrigin.onended = function () {
      disconnectAnalysers();
    };

    audioOrigin.onpause = function () {
      ee.emit('peaks.stop');
    };
    audioOrigin.onloadend = function () {
      console.log("loaded the audio");
    };

    peaksInstance = Peaks.init(options);

    document.querySelector('[data-action="zoom-in"]').addEventListener("click", peaksInstance.zoom.zoomIn.bind(peaksInstance));
    document.querySelector('[data-action="zoom-out"]').addEventListener("click", peaksInstance.zoom.zoomOut.bind(peaksInstance));

    document.querySelector('button[data-action="add-segment"]').addEventListener("click", function () {
      peaksInstance.segments.add({
        startTime: peaksInstance.time.getCurrentTime(),
        endTime: peaksInstance.time.getCurrentTime() + 10,
        editable: true
      });
    });

    document.querySelector('button[data-action="add-point"]').addEventListener("click", function () {
      peaksInstance.points.add({
        timestamp: peaksInstance.time.getCurrentTime(),
        editable: true
      });
    });

    document.querySelector('button[data-action="log-data"]').addEventListener("click", function (event) {
      console.log('Segments', peaksInstance.segments.getSegments());
      console.log('Points', peaksInstance.points.getPoints());
    });
  })(peaks);
</script>
</body>
</html>
